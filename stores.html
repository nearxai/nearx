<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NearX — Local Stores & WhatsApp Ordering</title>

<style>
  :root{--max-w:1100px;--accent1:#246BFD;--accent2:#6A11CB;--muted:#707582;--shadow:0 12px 30px rgba(10,10,40,0.06)}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;background:linear-gradient(180deg,#f7f9ff,#ffffff);color:#0b1221}
  .wrap{max-width:var(--max-w);margin:18px auto;padding:18px}

  header{display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}

  .hero{background:linear-gradient(135deg,#246BFD,#6A11CB);color:#fff;padding:28px;border-radius:22px;box-shadow:var(--shadow);margin-top:16px}
  .searchbar{display:flex;gap:10px;background:rgba(255,255,255,0.12);padding:8px;border-radius:12px;margin-top:10px}
  .searchbar input{flex:1;padding:12px;border:0;background:transparent;color:#fff;font-size:15px}
  .searchbar select{padding:10px;border:0;background:transparent;color:#fff;font-weight:700;border-radius:10px}
  .searchbar button{background:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:700}

  .cats{display:flex;gap:10px;overflow:auto;margin-top:14px}
  .cat{min-width:110px;background:#fff;padding:12px;border-radius:14px;text-align:center;cursor:pointer;box-shadow:var(--shadow)}

  main{display:flex;gap:22px;margin-top:22px}
  .left{flex:1}
  .right{width:360px}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
  .store-card{background:#fff;padding:14px;border-radius:18px;box-shadow:var(--shadow);display:flex;gap:12px}

  .thumb{width:80px;height:80px;border-radius:12px;object-fit:cover}
  .meta{font-size:13px;color:var(--muted)}

  .cart{background:#fff;padding:14px;border-radius:16px;box-shadow:var(--shadow);position:sticky;top:20px}
  .cart-row{padding:8px 0;border-bottom:1px dashed #eee;display:flex;justify-content:space-between}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:200}
  .modal{width:95%;max-width:860px;background:#fff;padding:18px;border-radius:14px;box-shadow:0 30px 60px rgba(10,10,40,0.3)}

  .prod-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px;margin-top:12px}
  .prod{padding:10px;border-radius:12px;border:1px solid #f1f4fb}

  .form-input{padding:10px;border:1px solid #ddd;border-radius:10px;width:100%;margin-top:8px}
  @media(max-width:980px){main{flex-direction:column}.right{width:100%;position:static}}

  .btn{cursor:pointer;padding:8px 12px;border-radius:10px;border:0;font-weight:700}
  .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">NX</div>
      <div>
        <h1>NearX Stores</h1>
        <div class="meta">Everything near you — order on WhatsApp</div>
      </div>
    </div>
    <div style="display:flex;gap:10px">
      <a href="index.html" class="meta">Home</a>
      <a href="crm.html" class="meta">CRM</a>
      <button id="merchantJoinBtn" class="btn btn-ghost">List Your Shop</button>
    </div>
  </header>

  <!-- HERO SEARCH -->
  <section class="hero">
    <h2>Find stores, compare prices & order instantly</h2>

    <div class="searchbar">
      <input id="q" placeholder="Search — sugar, rice, bakery, etc.">
      <select id="area"></select>
      <button id="searchBtn">Search</button>
    </div>

    <div class="cats" id="categories"></div>
  </section>

  <!-- MAIN CONTENT -->
  <main>
    <div class="left">
      <h3>Nearby Stores</h3>
      <div class="grid" id="storesGrid"></div>
    </div>

    <aside class="right">
      <div class="cart">
        <h4>Your Cart</h4>
        <div id="cartItems">No items</div>
        <div class="cart-row"><strong>Total</strong><strong id="cartTotal">₹0</strong></div>

        <input id="custName" class="form-input" placeholder="Your Name">
        <input id="custPhone" class="form-input" placeholder="WhatsApp Number">

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="clearCart" class="btn btn-ghost" style="flex:1">Clear</button>
          <button id="checkoutBtn" class="btn btn-primary" style="flex:1">Checkout on WhatsApp</button>
        </div>
      </div>
    </aside>
  </main>

  <footer style="text-align:center;margin-top:30px;color:var(--muted)">
    © <span id="year"></span> NearX Stores — Powered by WhatsApp
  </footer>
</div>

<!-- PRODUCT MODAL -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="modalTitle">Store</h3>
      <button onclick="hideModal('modalBackdrop')" class="btn btn-ghost">Close</button>
    </div>
    <p id="modalDesc" class="meta"></p>
    <div class="prod-grid" id="prodGrid"></div>
  </div>
</div>

<!-- MERCHANT FORM MODAL -->
<div class="modal-backdrop" id="merchantModal">
  <div class="modal">
    <h3>List Your Shop on NearX</h3>
    <p class="meta">We will create your shop ID & product sheet.</p>

    <form id="merchantForm" style="display:grid;gap:10px;margin-top:10px">
      <input name="shop_name" class="form-input" placeholder="Shop Name" required>
      <input name="owner_name" class="form-input" placeholder="Owner Name">
      <input name="phone" class="form-input" placeholder="WhatsApp Number" required>
      <input name="area" class="form-input" placeholder="Area / Locality" required>

      <select name="category" class="form-input" required>
        <option>Grocery</option>
        <option>Bakery</option>
        <option>Restaurant</option>
        <option>Pharmacy</option>
        <option>Electronics</option>
        <option>Fashion</option>
      </select>

      <textarea name="notes" class="form-input" placeholder="Short description"></textarea>

      <div style="display:flex;gap:10px">
        <button type="button" onclick="hideModal('merchantModal')" class="form-input" style="background:#eee">Cancel</button>
        <button type="submit" class="form-input" style="background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;border:0">Submit</button>
      </div>

      <div id="merchantMsg" style="display:none;color:green;font-weight:700;margin-top:10px"></div>
    </form>
  </div>
</div>

<script>
/* -------------------- CONFIG -------------------- */
const APPS_SCRIPT_BASE = "https://script.google.com/macros/s/AKfycbxtQlUjFOnWCf-5cx-yt3loLom-uYY-63mMrHFe7X0rMsSwsAeateCpuA32Vja5P-44/exec";

const DATA_URL = APPS_SCRIPT_BASE + "?action=get_all";

/* FIXED LINE — REQUIRED FOR SHEET TO UPDATE */
const MERCHANT_FORM_URL = APPS_SCRIPT_BASE + "?action=merchant";

/* -------------------- ICON MAP -------------------- */
const iconMap = {
  Grocery:"https://cdn-icons-png.flaticon.com/512/3515/3515285.png",
  Bakery:"https://cdn-icons-png.flaticon.com/512/922/922699.png",
  Restaurant:"https://cdn-icons-png.flaticon.com/512/1046/1046857.png",
  Pharmacy:"https://cdn-icons-png.flaticon.com/512/2965/2965567.png",
  Electronics:"https://cdn-icons-png.flaticon.com/512/1048/1048949.png",
  Fashion:"https://cdn-icons-png.flaticon.com/512/892/892458.png"
};

/* -------------------- VARIABLES -------------------- */
let stores = [], products = [], categories = [], cart = [], selectedStoreId = null;
document.getElementById("year").innerText = new Date().getFullYear();

/* -------------------- LOAD DATA -------------------- */
async function loadData(){
  try{
    const res = await fetch(DATA_URL);
    const json = await res.json();

    if(json && json.stores){
      stores = json.stores;
      products = json.products;
      categories = json.categories;
    } else throw "invalid";
  }
  catch(err){
    console.warn("Using fallback demo", err);
  }
  initUI();
}

/* -------------------- INITIAL UI SETUP -------------------- */
function initUI(){
  populateAreas();
  populateCategories();
  renderStores(stores);
}

/* AREAS */
function populateAreas(){
  const area = document.getElementById("area");
  area.innerHTML = "<option value=''>All</option>";
  [...new Set(stores.map(s=>s.area))].forEach(a=>{
    const opt = document.createElement("option");
    opt.value = a;
    opt.textContent = a;
    area.appendChild(opt);
  });
}

/* CATEGORIES */
function populateCategories(){
  const cont = document.getElementById("categories");
  cont.innerHTML = "";
  categories.forEach(c=>{
    const box = document.createElement("div");
    box.className = "cat";
    box.onclick = ()=>{ document.getElementById("q").value = c; searchStores(); };
    box.innerHTML = `
      <img src="${iconMap[c]||iconMap.Grocery}" style="width:44px;height:44px">
      <div style="margin-top:6px">${c}</div>
      <small class="meta">Tap to filter</small>
    `;
    cont.appendChild(box);
  });
}

/* STORE LIST */
function renderStores(list){
  const grid = document.getElementById("storesGrid");
  grid.innerHTML = "";
  if(!list.length){ grid.innerHTML = "<div class='meta'>No stores found</div>"; return; }

  list.forEach(s=>{
    const el = document.createElement("div");
    el.className="store-card";
    el.innerHTML = `
      <img class="thumb" src="${iconMap[s.category]||''}">
      <div>
        <h3 style="margin:0">${s.name}</h3>
        <div class="meta">${s.category} • ${s.area}</div>
        <div><button class="btn btn-ghost" onclick="openStore('${s.id}')">View</button></div>
      </div>
    `;
    grid.appendChild(el);
  });
}

/* SEARCH */
function searchStores(){
  const q = (document.getElementById("q").value || "").toLowerCase();
  const area = document.getElementById("area").value;

  const list = stores.filter(s =>
    (!q || s.name.toLowerCase().includes(q) || s.category.toLowerCase().includes(q) || (s.desc||"").toLowerCase().includes(q)) &&
    (!area || s.area === area)
  );

  renderStores(list);
}
document.getElementById("searchBtn").onclick = searchStores;

/* -------------------- VIEW STORE -------------------- */
function openStore(id){
  selectedStoreId = id;
  const s = stores.find(x=>x.id===id);

  document.getElementById("modalTitle").innerText = s?.name || "Store";
  document.getElementById("modalDesc").innerText = s?.desc || "";

  const grid = document.getElementById("prodGrid");
  grid.innerHTML = "";

  const list = products.filter(p => p.shop_id === id);
  if(!list.length){ grid.innerHTML = "<div class='meta'>No products added yet</div>"; return; }

  list.forEach(p=>{
    const safeId = encodeURIComponent(p.product).replace(/%/g,"_");
    const el = document.createElement("div");
    el.className="prod";
    el.innerHTML = `
      <img src="${p.image}">
      <div style="font-weight:700;margin-top:8px">${p.product}</div>
      <div class="meta">₹${p.price}</div>

      <div style="margin-top:8px;display:flex;gap:8px">
        <input type="number" min="1" value="1" id="qty-${safeId}" style="width:70px;padding:6px;border-radius:8px;border:1px solid #eee">
        <button class="btn btn-primary" onclick="addToCart('${p.product}',${p.price})">Add</button>
      </div>
    `;
    grid.appendChild(el);
  });

  showModal("modalBackdrop");
}

/* -------------------- CART -------------------- */
function addToCart(product, price){
  const safeId = encodeURIComponent(product).replace(/%/g,"_");
  const qty = Number(document.getElementById(`qty-${safeId}`).value || 1);

  if(cart.length && cart[0].shop_id !== selectedStoreId){
    if(!confirm("Cart has items from another shop. Clear?")) return;
    cart = [];
  }

  const existing = cart.find(c=>c.product===product);
  if(existing) existing.qty += qty;
  else cart.push({product, price, qty, shop_id:selectedStoreId});

  renderCart();
}

function renderCart(){
  const wrap = document.getElementById("cartItems");
  wrap.innerHTML = "";

  if(!cart.length){
    wrap.innerText = "No items";
    document.getElementById("cartTotal").innerText = "₹0";
    return;
  }

  let total = 0;

  cart.forEach((item, idx)=>{
    total += item.price * item.qty;
    const row = document.createElement("div");
    row.className="cart-row";
    row.innerHTML = `
      <div>${item.product} x${item.qty}</div>
      <div>₹${item.price * item.qty} 
        <button class="btn btn-ghost" onclick="removeItem(${idx})">✕</button>
      </div>
    `;
    wrap.appendChild(row);
  });

  document.getElementById("cartTotal").innerText = "₹" + total;
}

function removeItem(i){
  cart.splice(i,1);
  renderCart();
}

document.getElementById("clearCart").onclick = ()=>{
  cart = [];
  renderCart();
};

/* -------------------- CHECKOUT -------------------- */
document.getElementById("checkoutBtn").onclick = ()=>{
  if(!cart.length) return alert("Cart is empty.");

  const name = document.getElementById("custName").value.trim();
  const phone = document.getElementById("custPhone").value.trim();
  if(!name || !phone) return alert("Enter name & WhatsApp number");

  const store = stores.find(s=>s.id===cart[0].shop_id);

  let msg = `Hi, I want to place an order:\n\nName: ${name}\nPhone: ${phone}\n\nItems:\n`;
  cart.forEach(c=> msg += `• ${c.product} x${c.qty} — ₹${c.price*c.qty}\n`);

  msg += `\nTotal: ₹${cart.reduce((a,b)=>a+b.price*b.qty,0)}`;
  msg += `\nStore: ${store?.name || ""}`;

  const wa = (store?.phone || "").replace(/\D/g,"");
  window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`);
};

/* -------------------- MERCHANT FORM SUBMIT -------------------- */
document.getElementById("merchantJoinBtn").onclick = ()=> showModal("merchantModal");

document.getElementById("merchantForm").onsubmit = async e=>{
  e.preventDefault();

  const fd = new FormData(e.target);
  const data = { action:"merchant" };

  fd.forEach((v,k)=> data[k] = v);
  data.timestamp = new Date().toISOString();

  try{
    const res = await fetch(MERCHANT_FORM_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(data)
    });

    const json = await res.json();
    document.getElementById("merchantMsg").innerText =
      json.ok ? "Request submitted! We'll create your shop ID." : "Submitted!";
  }
  catch(e){
    document.getElementById("merchantMsg").innerText = "Request queued (offline)";
  }

  document.getElementById("merchantMsg").style.display="block";
  e.target.reset();
};

/* -------------------- MODAL -------------------- */
function showModal(id){ document.getElementById(id).style.display="flex"; }
function hideModal(id){ document.getElementById(id).style.display="none"; }

/* START */
loadData();
</script>

</body>
</html>
