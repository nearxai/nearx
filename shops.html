<script>
document.getElementById("year").innerText = new Date().getFullYear();

/* ðŸ”§ CONFIG â€” will be replaced when backend ready */
const DATA_URL = "";  // leave empty to use demo data
const MERCHANT_FORM_URL = "";  
const OWNER_PHONE_DEFAULT = "919000810084";

/* ---------------- DEMO DATA ---------------- */
const demoData = {
  stores: [
    {
      id: "S001",
      name: "Fresh Mart",
      category: "Grocery",
      area: "Dilsukhnagar",
      phone: "919000810084",
      thumb: "https://i.ibb.co/5xWt7gRM/file-00000000c66c7209aa546551ca843503-1.png",
      desc: "Daily groceries & staples"
    },
    {
      id: "S002",
      name: "Bakers Hub",
      category: "Bakery",
      area: "LB Nagar",
      phone: "919111111111",
      thumb: "https://i.ibb.co/5xWt7gRM/file-00000000c66c7209aa546551ca843503-1.png",
      desc: "Fresh breads & cakes"
    }
  ],
  products: [
    { shop_id: "S001", product: "Sugar 1kg", price: 45, stock: 30, image: "https://i.ibb.co/5xWt7gRM/file.png" },
    { shop_id: "S001", product: "Rice 5kg", price: 325, stock: 12, image: "https://i.ibb.co/5xWt7gRM/file.png" },
    { shop_id: "S002", product: "Chocolate Cake", price: 350, stock: 6, image: "https://i.ibb.co/5xWt7gRM/file.png" }
  ],
  categories: ["Grocery", "Bakery", "Restaurant", "Pharmacy", "Fashion"]
};

let stores = [];
let products = [];
let categories = [];
let cart = [];
let selectedStoreId = null;

function money(n){ return "â‚¹" + Number(n||0).toFixed(0); }

/* ---------------- LOAD DATA ---------------- */
async function loadData(){
  stores = demoData.stores;
  products = demoData.products;
  categories = demoData.categories;

  loadAreas();
  loadCategories();
  renderStores(stores);
}

function loadAreas(){
  const area = document.getElementById("area");
  area.innerHTML = `<option value="">All Areas</option>`;
  [...new Set(stores.map(s => s.area))].forEach(a => {
    area.innerHTML += `<option value="${a}">${a}</option>`;
  });
}

function loadCategories(){
  const cats = document.getElementById("categories");
  cats.innerHTML = "";

  categories.forEach(c => {
    const box = document.createElement("div");
    box.className = "cat";

    box.innerHTML = `
      <img src="https://via.placeholder.com/64?text=${c.charAt(0)}" />
      <div>${c}</div>
      <small>Tap to search</small>
    `;

    box.onclick = () => {
      document.getElementById("q").value = c;
      searchStores();
    };

    cats.appendChild(box);
  });
}

function renderStores(list){
  const grid = document.getElementById("storesGrid");
  grid.innerHTML = "";

  list.forEach(s => {
    grid.innerHTML += `
      <div class="store-card">
        <img class="thumb" src="${s.thumb}" />
        <div>
          <h3>${s.name}</h3>
          <div class="meta">${s.category} â€¢ ${s.area}</div>
          <div class="meta">${s.desc || ""}</div>
          <div style="margin-top:6px; display:flex; gap:8px;">
            <button class="btn btn-ghost" onclick="openStore('${s.id}')">View</button>
            <button class="btn btn-primary" onclick="openStore('${s.id}')">Order</button>
          </div>
        </div>
      </div>
    `;
  });
}

/* ---------------- SEARCH ---------------- */
function searchStores(){
  const q = document.getElementById("q").value.toLowerCase();
  const area = document.getElementById("area").value;

  let results = stores.filter(s =>
    (!q || s.name.toLowerCase().includes(q) || s.category.toLowerCase().includes(q))
    && (!area || s.area === area)
  );

  renderStores(results);
}

document.getElementById("searchBtn").onclick = searchStores;

/* ---------------- PRODUCT MODAL ---------------- */
function openStore(id){
  selectedStoreId = id;
  const store = stores.find(s => s.id === id);
  const list = products.filter(p => p.shop_id === id);

  document.getElementById("modalTitle").innerText = store.name;
  document.getElementById("modalDesc").innerText = store.desc || "";

  const grid = document.getElementById("prodGrid");
  grid.innerHTML = "";

  list.forEach(p => {
    grid.innerHTML += `
      <div class="prod">
        <img src="${p.image}">
        <div>${p.product}</div>
        <div>${money(p.price)}</div>
        <div style="margin-top:6px; display:flex; gap:8px;">
          <input id="qty-${p.product}" type="number" min="1" value="1" style="width:70px;">
          <button class="btn btn-primary" onclick="addToCart('${p.product}', ${p.price})">Add</button>
        </div>
      </div>
    `;
  });

  document.getElementById("modalBackdrop").style.display = "flex";
}

document.getElementById("closeModal").onclick = () => {
  document.getElementById("modalBackdrop").style.display = "none";
};

/* ---------------- CART ---------------- */
function addToCart(product, price){
  const qty = Number(document.getElementById(`qty-${product}`).value);

  cart.push({
    product, price, qty,
    shop_id: selectedStoreId
  });

  renderCart();
}

function renderCart(){
  const div = document.getElementById("cartItems");

  if (!cart.length){
    div.innerHTML = "No items";
    document.getElementById("cartTotal").innerText = "â‚¹0";
    return;
  }

  div.innerHTML = "";
  let total = 0;

  cart.forEach((c, i) => {
    total += c.price * c.qty;

    div.innerHTML += `
      <div class="cart-row">
        <div>${c.product} x${c.qty}</div>
        <div>${money(c.price * c.qty)}</div>
      </div>
    `;
  });

  document.getElementById("cartTotal").innerText = money(total);
}

document.getElementById("clearCart").onclick = () => {
  cart = [];
  renderCart();
};

/* ---------------- CHECKOUT ---------------- */
document.getElementById("checkoutBtn").onclick = () => {
  if (!cart.length){
    alert("Cart is empty");
    return;
  }

  const name = document.getElementById("custName").value;
  const phone = document.getElementById("custPhone").value;

  if (!name || !phone){
    alert("Enter your name & WhatsApp number");
    return;
  }

  const store = stores.find(s => s.id === cart[0].shop_id);
  const merchant = store.phone || OWNER_PHONE_DEFAULT;

  let msg = `Hi, I'd like to place an order:\n\nName: ${name}\nPhone: ${phone}\n\nItems:\n`;

  cart.forEach(c => {
    msg += `â€¢ ${c.product} x${c.qty} - ${money(c.price * c.qty)}\n`;
  });

  window.open(`https://wa.me/${merchant}?text=${encodeURIComponent(msg)}`);
};

/* ---------------- LOAD PAGE ---------------- */
loadData();
</script>
